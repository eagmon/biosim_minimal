"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.karmaGenerator = void 0;
const tslib_1 = require("tslib");
const devkit_1 = require("@nrwl/devkit");
const path_1 = require("path");
const versions_1 = require("../../utils/versions");
const version_utils_1 = require("../utils/version-utils");
function addTestInputs(tree) {
    var _a, _b, _c, _d;
    var _e, _f;
    const nxJson = (0, devkit_1.readNxJson)(tree);
    const productionFileSet = (_a = nxJson.namedInputs) === null || _a === void 0 ? void 0 : _a.production;
    if (productionFileSet) {
        productionFileSet.push(
        // Exclude spec files from production fileset
        '!{projectRoot}/**/*.spec.[jt]s', 
        // Remove tsconfig.spec.json
        '!{projectRoot}/tsconfig.spec.json', 
        // Remove karma.conf.js
        '!{projectRoot}/karma.conf.js');
        // Dedupe and set
        nxJson.namedInputs.production = Array.from(new Set(productionFileSet));
    }
    // Test targets depend on all their project's sources + production sources of dependencies
    (_b = nxJson.targetDefaults) !== null && _b !== void 0 ? _b : (nxJson.targetDefaults = {});
    (_c = (_e = nxJson.targetDefaults).test) !== null && _c !== void 0 ? _c : (_e.test = {});
    (_d = (_f = nxJson.targetDefaults.test).inputs) !== null && _d !== void 0 ? _d : (_f.inputs = [
        'default',
        productionFileSet ? '^production' : '^default',
    ]);
    nxJson.targetDefaults.test.inputs.push('{workspaceRoot}/karma.conf.js');
    (0, devkit_1.updateNxJson)(tree, nxJson);
}
function karmaGenerator(tree, options) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const generatorDirectory = (0, version_utils_1.getGeneratorDirectoryForInstalledAngularVersion)(tree);
        if (generatorDirectory) {
            let previousGenerator = yield Promise.resolve().then(() => require((0, path_1.join)(__dirname, generatorDirectory, 'karma')));
            yield previousGenerator.default(tree, options);
            return;
        }
        const packageJson = (0, devkit_1.readJson)(tree, 'package.json');
        if (!tree.exists('karma.conf.js')) {
            (0, devkit_1.generateFiles)(tree, (0, devkit_1.joinPathFragments)(__dirname, 'files'), '.', {
                tmpl: '',
            });
            addTestInputs(tree);
        }
        if (options.skipPackageJson || packageJson.devDependencies['karma']) {
            return () => { };
        }
        return (0, version_utils_1.addDependenciesToPackageJsonIfDontExist)(tree, {}, {
            karma: versions_1.karmaVersion,
            'karma-chrome-launcher': versions_1.karmaChromeLauncherVersion,
            'karma-coverage': versions_1.karmaCoverageVersion,
            'karma-jasmine': versions_1.karmaJasmineVersion,
            'karma-jasmine-html-reporter': versions_1.karmaJasmineHtmlReporterVersion,
            'jasmine-core': versions_1.jasmineCoreVersion,
            'jasmine-spec-reporter': versions_1.jasmineSpecReporterVersion,
            '@types/jasmine': versions_1.typesJasmineVersion,
            '@types/node': versions_1.typesNodeVersion,
        });
    });
}
exports.karmaGenerator = karmaGenerator;
exports.default = karmaGenerator;
//# sourceMappingURL=karma.js.map